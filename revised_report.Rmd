---
title: "Revised Report"
author: "Oscar Su"
date: "2025-03-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo = T, warning=FALSE, message=FALSE}
library(tidyverse)
library(car)
library(GGally)
library(MASS)
library(vtable)
data <- read.csv("cleaned_dataset.csv", header=TRUE) %>% dplyr::select(-X)
attach(data)
```
# Summary statistics and data exploration

## Distribution of categorical variables
```{r}
par(mfrow = c(1, 2))
company_type <- table(NACE.Letter)
barplot(company_type, xlab="Company Type by NACE Letters", ylab="Count")

report_years <- table(Report.Year)
barplot(report_years, xlab="Year Reported", ylab="Count")

# create an added variable group
data$group <- ifelse(data$NACE.Letter %in% c('F', 'K', 'M'), 1, 0)
head(data)
#group 1 is denoted by 1
#group 2 is denoted by 0

#Two groups 
## Companies that have NACE letter F, K, or M
group_1 <- data %>% filter(NACE.Letter %in% c('F', 'K', 'M'))
## Companies not in these letters
group_2 <- data %>% filter(!(NACE.Letter %in% c('F', 'K', 'M')))

# I created two distinct groups using the pipe operator and in function! lmk if you guys want me to make any changes
# - Shelby
```

## Extract variables

```{r}
new_table <- data %>% dplyr::select(-c(`Company.Name`, `NACE.Section`, `NACE.Letter`, `NACE.Division`, `Q1.Female`, `Q2.Female`, `Q3.Female`, `Q4.Female`, `Q1.Men`, `Q2.Male`, `Q3.Male`, `Q4.Male`))

group_1_table <- group_1 %>% dplyr::select(-c(`Company.Name`, `NACE.Section`, `NACE.Letter`, `NACE.Division`, `Q1.Female`, `Q2.Female`, `Q3.Female`, `Q4.Female`, `Q1.Men`, `Q2.Male`, `Q3.Male`, `Q4.Male`)) 

group_2_table <- group_2 %>% dplyr::select(-c(`Company.Name`, `NACE.Section`, `NACE.Letter`, `NACE.Division`, `Q1.Female`, `Q2.Female`, `Q3.Female`, `Q4.Female`, `Q1.Men`, `Q2.Male`, `Q3.Male`, `Q4.Male`))
```


### Summary Table
```{r}
st(new_table, digits=4)

st(group_1_table, digits =4,title = "Group 1 Summary Statistics")

st(group_2_table, digits =4,title = "Group 2 Summary Statistics")
```

### Distribution of variables
```{r}
par(mfrow = c(2,4))
for (col in 2:ncol(new_table)){
  hist(new_table[, col], main=colnames(new_table)[col], xlab=colnames(new_table)[col])
}

#group 1
par(mfrow = c(2,4))
for (col in 2:ncol(group_1_table)){
  hist(group_1_table[, col], main=colnames(group_1_table)[col], xlab=colnames(group_1_table)[col])
}

#group 2
par(mfrow = c(2,4))
for (col in 2:ncol(group_2_table)){
  hist(group_2_table[, col], main=colnames(group_2_table)[col], xlab=colnames(group_2_table)[col])
}
```


### Correlation table
```{r}
cor(new_table)
pairs(new_table)

#group 1
cor(group_1_table)
pairs(group_1_table)

#group 2
cor(group_2_table)
pairs(group_2_table)
```

Removing highly correlated variables
```{r}
new_table <- new_table %>% dplyr::select(-c(`Median.Hourly.Gap`, `Median.Hourly.Gap.Part.Time`, `Median.Hourly.Gap.Part.Temp`, `Percentage.Bonus.Paid.Male`, `Percentage.BIK.Paid.Male`, `Percentage.Employees.Male`))

st(new_table, digits = 3)

#option 2 simple linear regression as opposed to bin log reg
group_1_table <- group_1_table %>% dplyr::select(-c(`Median.Hourly.Gap`, `Median.Hourly.Gap.Part.Time`, `Median.Hourly.Gap.Part.Temp`, `Percentage.Bonus.Paid.Male`, `Percentage.BIK.Paid.Male`, `Percentage.Employees.Male`))

st(group_1_table, digits = 3)

group_2_table <- group_2_table %>% dplyr::select(-c(`Median.Hourly.Gap`, `Median.Hourly.Gap.Part.Time`, `Median.Hourly.Gap.Part.Temp`, `Percentage.Bonus.Paid.Male`, `Percentage.BIK.Paid.Male`, `Percentage.Employees.Male`))

st(group_2_table, digits = 3)
```

## Results and Interpretation

```{r}
full_model <- lm(`Mean.Hourly.Gap` ~ ., data = new_table)
summary(full_model)

par(mfrow = c(2,2))
plot(full_model)

#maybe we could use binomial logisitic regression to interpret whether or
# not there is a sig diff between groups 1 and 2
# binomial log reg  
# group vs. mean hour gap
#logit_model <- glm(group ~ `Mean.Hourly.Gap`, data = data, family = binomial)
#group vs. all other variables
#logit_model_all <- glm(group ~ ., data = data, family = binomial)


#summary(logit_model)
#summary(logit_model_all)

# not sure if this is a viable solution


#option 2 simple linear regression as opposed to bin log reg
#group_1_full_model <- lm(`Mean.Hourly.Gap` ~ ., data = group_1_table)
#summary(group_1_full_model)

#group_2_full_model <- lm(`Mean.Hourly.Gap` ~ ., data = group_2_table)
#summary(group_2_full_model)

```

The Residuals vs Fitted plot shows the relationship is linear at mean 0. The Q-Q plot shows heavy tailing indicating deviation from normality. There also seems to be non-constant variance shown in the standardized residuals plot which violates the linear model assumption. Residuals vs Leverage doesn't show any outliers or leverage points that need inspection.

```{r bi}

#g_diff <- logit_model_all$null.deviance - logit_model_all$deviance
#g_diff

#pchisq(g_diff,806,lower.tail=FALSE)

```
Since our p-value 9.684606e-50 is smaller than 0.05, the predictors in the model,
significantly improve model fit.

### Transformation
```{r}
shifted_table <- new_table %>% 
  mutate(`Mean.Hourly.Gap` = `Mean.Hourly.Gap` + 1 - min(`Mean.Hourly.Gap`)) %>% 
  mutate(`Mean.Bonus.Gap` = `Mean.Bonus.Gap` + 1 - min(`Mean.Bonus.Gap`)) %>% 
  mutate(`Median.Bonus.Gap` = `Median.Bonus.Gap` + 1 - min(`Median.Bonus.Gap`)) %>% 
  mutate(`Mean.Hourly.Gap.Part.Time` = `Mean.Hourly.Gap.Part.Time` + 1 - min(`Mean.Hourly.Gap.Part.Time`)) %>% 
  mutate(`Mean.Hourly.Gap.Part.Temp` = `Mean.Hourly.Gap.Part.Temp` + 1 - min(`Mean.Hourly.Gap.Part.Temp`)) %>% 
  mutate(`Percentage.Bonus.Paid.Female` = `Percentage.Bonus.Paid.Female` + 1) %>% 
  mutate(`Percentage.BIK.Paid.Female` = `Percentage.BIK.Paid.Female` + 1) %>% 
  mutate(`Percentage.Employees.Female` = `Percentage.Employees.Female` + 1)

attach(shifted_table)
#method 1
summary(powerTransform(cbind(Mean.Hourly.Gap, Report.Year,Mean.Bonus.Gap, Median.Bonus.Gap, Mean.Hourly.Gap.Part.Temp, Mean.Hourly.Gap.Part.Time, Percentage.Bonus.Paid.Female, Percentage.BIK.Paid.Female,Percentage.Employees.Female)~1))
# Percentage.Bonus.Paid.Female, Percentage.BIK.Paid.Female,Percentage.Employees.Female
```

```{r}
#fit transformed
attach(new_table)
tMHG <- `Mean.Hourly.Gap`^0.73
tRY <- `Report.Year`^3
tMBG <- `Mean.Bonus.Gap`^0.72
tMeBG <- `Median.Bonus.Gap`^6.5
tMHGPTe <- `Mean.Hourly.Gap.Part.Temp`^1.68
tMHGPTi <- `Mean.Hourly.Gap.Part.Time`^2.23
tPBPF <- `Percentage.Bonus.Paid.Female`^0.3
tPBIKPF <- `Percentage.BIK.Paid.Female`^0.07
tPEF <- `Percentage.Employees.Female`^0.87

#NaN produced
tTable <- data.frame(cbind(tMHG, tRY, tMBG, tMeBG, tMHGPTe, tMHGPTi, tPBPF, tPBIKPF, tPEF))
st(tTable)

tModel <- lm(tMHG ~ tRY + tMBG + tMeBG + tMHGPTe + tMHGPTi+tPBPF+tPBIKPF+tPEF)
summary(tModel)

par(mfrow=c(2,2))
plot(tModel)
```
Look at correlation
```{r}
pairs(tMHG ~ tRY + tMBG + tMeBG + tMHGPTe + tMHGPTi+tPBPF+tPBIKPF+tPEF)
```
```{r}
# VIF
vif(tModel)  # If VIF > 5, consider removing redundant variables
```

# Variable selection

## All subsets
```{r}
library(leaps)
X <- cbind(tRY,tMBG,tMeBG,tMHGPTe,tMHGPTi,tPBPF,tPBIKPF,tPEF)

#b <- regsubsets(as.matrix(X), tMHG) #CAN'T FIT SINCE THERE ARE NaNs
#summary(b)

##TODO Try variable selection with original (non-transformed) model
attach(new_table)
X <- cbind(Report.Year, Mean.Bonus.Gap, Median.Bonus.Gap, Mean.Hourly.Gap.Part.Time, Mean.Hourly.Gap.Part.Temp, Percentage.BIK.Paid.Female, Percentage.Bonus.Paid.Female, Percentage.Employees.Female)
b <- regsubsets(as.matrix(X), Mean.Hourly.Gap)
summary(b)

#per the subset suggestions...
## p = 1
om1 <- lm(Mean.Hourly.Gap ~ Mean.Bonus.Gap)
p <- 1; n <- nrow(new_table)

Rad1 <- summary(om1)$adj.r.squared
AIC1 <- extractAIC(om1)[2]
AICc1 <- extractAIC(om1)[2] + 2*(p+2)*(p+3)/(n-p-1)
BIC1 <- extractAIC(om1, k=log(n))[2]
M1 <- c(Rad1, AIC1, AICc1, BIC1)

## p = 2
om2 <- lm(Mean.Hourly.Gap ~ Mean.Bonus.Gap+Percentage.Bonus.Paid.Female)
p <- 2; n <- nrow(new_table)

Rad2 <- summary(om2)$adj.r.squared
AIC2 <- extractAIC(om2)[2]
AICc2 <- extractAIC(om2)[2] + 2*(p+2)*(p+3)/(n-p-1)
BIC2 <- extractAIC(om2, k=log(n))[2]
M2 <- c(Rad2, AIC2, AICc2, BIC2)

## p = 3
om3 <- lm(Mean.Hourly.Gap ~ Mean.Bonus.Gap+Mean.Hourly.Gap.Part.Time+Percentage.Bonus.Paid.Female)
p <- 3; n <- nrow(new_table)

Rad3 <- summary(om3)$adj.r.squared
AIC3 <- extractAIC(om3)[2]
AICc3 <- extractAIC(om3)[2] + 2*(p+2)*(p+3)/(n-p-1)
BIC3 <- extractAIC(om3, k=log(n))[2]
M3 <- c(Rad3, AIC3, AICc3, BIC3)

## p = 4
om4 <- lm(Mean.Hourly.Gap ~ Mean.Bonus.Gap+Mean.Hourly.Gap.Part.Time+Percentage.Bonus.Paid.Female+Percentage.Employees.Female)
p <- 4; n <- nrow(new_table)

Rad4 <- summary(om4)$adj.r.squared
AIC4 <- extractAIC(om4)[2]
AICc4 <- extractAIC(om4)[2] + 2*(p+2)*(p+3)/(n-p-1)
BIC4 <- extractAIC(om4, k=log(n))[2]
M4 <- c(Rad4, AIC4, AICc4, BIC4)

## p = 5
om5 <- lm(Mean.Hourly.Gap ~ Mean.Bonus.Gap+Mean.Hourly.Gap.Part.Time+Mean.Hourly.Gap.Part.Temp+Percentage.Bonus.Paid.Female+Percentage.Employees.Female)
p <- 5; n <- nrow(new_table)

Rad5 <- summary(om5)$adj.r.squared
AIC5 <- extractAIC(om5)[2]
AICc5 <- extractAIC(om5)[2] + 2*(p+2)*(p+3)/(n-p-1)
BIC5 <- extractAIC(om5, k=log(n))[2]
M5 <- c(Rad5, AIC5, AICc5, BIC5)

## p = 6
om6 <- lm(Mean.Hourly.Gap ~ Mean.Bonus.Gap+Median.Bonus.Gap+Mean.Hourly.Gap.Part.Time+Mean.Hourly.Gap.Part.Temp+Percentage.BIK.Paid.Female+Percentage.Bonus.Paid.Female+Percentage.Employees.Female)
p <- 6; n <- nrow(new_table)

Rad6 <- summary(om6)$adj.r.squared
AIC6 <- extractAIC(om6)[2]
AICc6 <- extractAIC(om6)[2] + 2*(p+2)*(p+3)/(n-p-1)
BIC6 <- extractAIC(om6, k=log(n))[2]
M6 <- c(Rad6, AIC6, AICc6, BIC6)

## p = 7
om7 <- lm(Mean.Hourly.Gap ~ Mean.Bonus.Gap+Median.Bonus.Gap+Mean.Hourly.Gap.Part.Time+Mean.Hourly.Gap.Part.Temp+Percentage.BIK.Paid.Female+Percentage.Bonus.Paid.Female+Percentage.Employees.Female)
p <- 7; n <- nrow(new_table)

Rad7 <- summary(om7)$adj.r.squared
AIC7 <- extractAIC(om7)[2]
AICc7 <- extractAIC(om7)[2] + 2*(p+2)*(p+3)/(n-p-1)
BIC7 <- extractAIC(om7, k=log(n))[2]
M7 <- c(Rad7, AIC7, AICc7, BIC7)

## p = 8
om8 <- lm(Mean.Hourly.Gap ~ Report.Year+ Mean.Bonus.Gap+Median.Bonus.Gap+Mean.Hourly.Gap.Part.Time+Mean.Hourly.Gap.Part.Temp+Percentage.BIK.Paid.Female+Percentage.Bonus.Paid.Female+Percentage.Employees.Female)
p <- 8; n <- nrow(new_table)

Rad8 <- summary(om8)$adj.r.squared
AIC8 <- extractAIC(om8)[2]
AICc8 <- extractAIC(om8)[2] + 2*(p+2)*(p+3)/(n-p-1)
BIC8 <- extractAIC(om8, k=log(n))[2]
M8 <- c(Rad8, AIC8, AICc8, BIC8)

compare_table <- data.frame(rbind(M1, M2, M3, M4, M5, M6, M7, M8))
names(compare_table) <- c("Rad", "AIC", "AICc", "BIC")
compare_table

which(compare_table$Rad == max(compare_table$Rad))
which(compare_table$AIC == min(compare_table$AIC))
which(compare_table$AICc == min(compare_table$AICc))
which(compare_table$BIC == min(compare_table$BIC))

summary(om8)
```

Full subset exploration suggests the full model

## Backward selection
```{r}
backwardAIC <- step(full_model, direction = "backward", data = new_table)
```

## Forward selection
```{r}
mint <- lm(Mean.Hourly.Gap~1,data=new_table)
forwardAIC <- step(mint, scope=list(lower = ~1, upper=~Report.Year+ Mean.Bonus.Gap+Median.Bonus.Gap+Mean.Hourly.Gap.Part.Time+Mean.Hourly.Gap.Part.Temp+Percentage.BIK.Paid.Female+Percentage.Bonus.Paid.Female+Percentage.Employees.Female), direction="forward", data=new_table)
```

# Suggestions from Professor

push by adding constant before box-cox and then apply transformation to the original variabels
